"""dedupe gd mst sofa new

Revision ID: f5a2f1c9b8a0
Revises: b2c7b87a2f1a
Create Date: 2026-02-10

"""

from __future__ import annotations

from alembic import op

# revision identifiers, used by Alembic.
revision = "f5a2f1c9b8a0"
down_revision = "b2c7b87a2f1a"
branch_labels = None
depends_on = None


def upgrade() -> None:
    op.execute("\nWITH existing AS (\n  SELECT id\n  FROM checklists\n  WHERE group_key = 'gd_mst_sofa_new' AND project_id IS NULL\n  LIMIT 1\n),\nins AS (\n  INSERT INTO checklists (title, group_key, project_id, task_id, note, default_owner, default_time, position)\n  SELECT 'GD MST SOFA NEW', 'gd_mst_sofa_new', NULL, NULL, NULL, NULL, NULL, NULL\n  WHERE NOT EXISTS (SELECT 1 FROM existing)\n  RETURNING id\n),\ntarget AS (\n  SELECT id FROM ins\n  UNION ALL\n  SELECT id FROM existing\n)\nINSERT INTO checklist_items (checklist_id, item_type, position, path, title, keyword, description, is_checked)\nSELECT\n  (SELECT id FROM target),\n  'CHECKBOX',\n  v.position,\n  'gd_mst_sofa_new',\n  v.title,\n  v.keyword,\n  v.description,\n  false\nFROM (\n  VALUES\n    (0, $$PIKAT E SELLING IMAGE 1$$, $$PIKAT GJENERALE- SELLING IMAGE_1$$,\n     $$Varesisht prej kategorise dhe funksioneve qe ka produkti, krijohen pikat dhe fotografi te ndryshme.\n\nMAX & MIN per Selling image_ eshte 3 foto dhe 3 pershkrime qe jane ne perputhje me ato foto.\nNe momentin qe produkti ka funksione, permenden te gjitha funksionet. Ne rast se produkti nuk ka funksione, fokusohemi tek materiali dhe dizajni.\nIkonat duhet te jene ne distance jo te ngjitura me tekst.\nTeksti duhet te jete paralel me foto.\nModernes Design – dizajn modern dhe formë elegante që përshtatet në çdo ambient.\nHochwertige Materialien – materiale cilësore dhe konstruksion i fortë për jetëgjatësi.\nFunktionale Schlaffunktion – funksion fjetjeje praktik për relaks ose mysafirë\nVerstellbarer Sitzkomfort – mbështetje dhe thellësi uljeje e rregullueshme për rehati maksimale.\nPraktischer Stauraum – hapësirë e integruar për ruajtje (për jastëkë, batanije etj.).$$),\n    (1, $$PIKAT E SELLING IMAGE 1$$, $$VENDOSJA E FOTOVE NE KOCKA$$,\n     $$Selling image_1 duhet të ketë së paku 3 kocka minimum:\n\nFOTO 1. pamjen e përgjithshme të divanit, (Kur nuk kemi funksion, per tu verejtur dizajni)\nFOTO 2. Materialin dhe teksturën e pëlhurës, (Kur nuk kemi funksion, per tu verejtur materiali)\nFOTO 3. Funksionin e shtrirjes,\n\nKur kockat vrehen mire per shkak te backgroundi ku mund te jep i zi dhe kockat e zeza ateher kockat duhet qe te i vendoset nje STROKE ne photoshop me ngjyre te bardh.$$),\n    (2, $$PIKAT E SELLING IMAGE 1$$, $$LOGO$$,\n     $$1. Gjithmone logo e klientit e konfirmuar me email (Set One) ose (MST) vendoset larte majtas fotos\n2. Gjithmone logoja e garancise 5 vite vendoset poshte majtas fotos\n\nNe baze te ngjyrave te fotos zgjedhen edhe ngjyrat e logos qe do te perdorim$$),\n    (3, $$PIKAT E SELLING IMAGE 1$$, $$BACKGROUND$$,\n     $$Ne Background gjithmon vendoset fotoja e setit\nNese nuk ka foto ne set ateher vendoset foto e type me background.\nFoto e background nuk duhet të preket me kockat → duhet të ketë hapësirë mes kockave dhe setit mbrapa$$),\n    (4, $$PIKAT E SELLING IMAGE 1$$, $$EMERTIMI$$,\n     $$MST: Selling image 1 duhet gjithmone te emertohet kodi i produktit SKU (KODI I MST) dhe _7$$),\n    (5, $$PIKAT E SELLING IMAGE 1$$, $$EMERTIMI$$,\n     $$OTTO: Selling image 1 duhet gjithmone te emertohet kodi i produktit Article code (KODI I OTTOs) dhe _7\nKur behet emertimi I fotove me kod te OTTOs duhet te kemi shume kujdes dhe patjeter te behen 2 kontrolla$$),\n    (6, $$PIKAT E SELLING IMAGE 2- SKICA$$, $$PIKAT GJENERALE$$,\n     $$Ne kete foto duhet te jete vetem Skica me dimensione. Nuk vendosim asnje tekst perveq ne Header si titull. Gjithashtu Headeri duket te kombinohet me ngjyrat e Selling Image_1 per t'u perputhur ne dizajn,$$),\n    (7, $$PIKAT E SELLING IMAGE 2- SKICA$$, $$LOGO$$,\n     $$1. Gjithmone logo e klientit e konfirmuar me email (Set One) ose (MST) vendoset larte majtas fotos\n2. Gjithmone logoja e garancise 5 vite vendoset poshte majtas fotos\n\nNe baze te ngjyrave te fotos zgjedhen edhe ngjyrat e logos qe do te perdorim$$),\n    (8, $$PIKAT E SELLING IMAGE 2- SKICA$$, $$FOTO$$,\n     $$1. Duhet te vendoset skica e produktit nga assembly instructions me dimensione\nNese nuk kemi skica/AI te produktit merret foto e produktit ne perspektive white background behet bardh e zi dhe vendosen dimensionet manualisht\n2. Duhet te kemi kujdes dhe vijat e dimensioneve mos te prekin produktin$$),\n    (9, $$PIKAT E SELLING IMAGE 2- SKICA$$, $$EMERTIMI$$,\n     $$MST: Selling image 1 duhet gjithmone te emertohet kodi i produktit SKU (KODI I MST) dhe _1\nOTTO: Selling image 1 duhet gjithmone te emertohet kodi i produktit Article code (KODI I OTTOs) dhe _1\nKur behet emertimi I fotove me kod te OTTOs duhet te kemi shume kujdes dhe patjeter te behen 2 kontrolla$$),\n    (10, $$PIKAT E SELLING IMAGE 3- NGJYRAT$$, $$PIKAT GJENERALE$$,\n     $$Materiali duhet te konfirmohet me MST- dhe te paraqiten te gjitha ngjyrat qe jane te disponueshme per ate produkt.$$),\n    (11, $$PIKAT E SELLING IMAGE 3- NGJYRAT$$, $$LOGOT$$,\n     $$1. Gjithmone logo e klientit e konfirmuar me email (Set One) ose (MST) vendoset larte majtas fotos\n2. Gjithmone logoja e garancise 5 vite vendoset poshte majtas fotos\n\nNe baze te ngjyrave te fotos zgjedhen edhe ngjyrat e logos qe do te perdorim$$)\n) AS v(position, title, keyword, description)\nWHERE NOT EXISTS (\n  SELECT 1 FROM checklist_items ci\n  WHERE ci.checklist_id = (SELECT id FROM target)\n    AND lower(trim(coalesce(ci.title, ''))) = lower(trim(coalesce(v.title, '')))\n    AND lower(trim(coalesce(ci.keyword, ''))) = lower(trim(coalesce(v.keyword, '')))\n    AND lower(trim(coalesce(ci.description, ''))) = lower(trim(coalesce(v.description, '')))\n);\n\nWITH project_items AS (\n  SELECT\n    ci.id,\n    ci.checklist_id,\n    ci.path,\n    ci.position,\n    ci.title,\n    ci.keyword,\n    ci.description\n  FROM checklist_items ci\n  JOIN checklists c ON c.id = ci.checklist_id\n  WHERE c.project_id IS NOT NULL\n    AND ci.path = 'gd_mst_sofa_new'\n),\nranked AS (\n  SELECT\n    id,\n    checklist_id,\n    path,\n    position,\n    ROW_NUMBER() OVER (\n      PARTITION BY\n        checklist_id,\n        path,\n        lower(trim(coalesce(title, ''))),\n        lower(trim(coalesce(keyword, ''))),\n        lower(trim(coalesce(description, '')))\n      ORDER BY position NULLS LAST, id\n    ) AS rn\n  FROM project_items\n),\nto_delete AS (\n  SELECT id FROM ranked WHERE rn > 1\n),\ndeleted AS (\n  DELETE FROM checklist_items\n  WHERE id IN (SELECT id FROM to_delete)\n  RETURNING checklist_id, path\n),\naffected AS (\n  SELECT DISTINCT checklist_id, path FROM deleted\n),\nrenumbered AS (\n  SELECT\n    ci.id,\n    ci.checklist_id,\n    ci.path,\n    ROW_NUMBER() OVER (\n      PARTITION BY ci.checklist_id, ci.path\n      ORDER BY ci.position NULLS LAST, ci.id\n    ) - 1 AS new_position\n  FROM checklist_items ci\n  JOIN affected a\n    ON a.checklist_id = ci.checklist_id\n   AND a.path = ci.path\n)\nUPDATE checklist_items ci\nSET position = r.new_position\nFROM renumbered r\nWHERE ci.id = r.id;\n")


def downgrade() -> None:
    pass
