name: Primex Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false 
          fetch-depth: 0

      - name: Force Sync with GitHub
        shell: cmd
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Create Env Files
        shell: cmd
        run: |
          echo NEXT_PUBLIC_API_URL=https://api-flow.primexeu.com > frontend/.env.local
          echo DATABASE_URL=postgresql+asyncpg://postgres:12345678@localhost:5433/primex_nexus > backend/.env
          echo JWT_SECRET=primex_nexus_secret_key_2026 >> backend/.env
          echo REDIS_URL=redis://localhost:6379/0 >> backend/.env
          echo CORS_ORIGINS=https://primeflow.primexeu.com,https://api-flow.primexeu.com >> backend/.env

      - name: Update Backend
        shell: cmd
        run: |
          cd backend
          "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" -m pip install -r requirements.txt
          "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" -m alembic upgrade head
          pm2 restart backend || pm2 start "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" --name backend -- -m uvicorn app.main:app --host 0.0.0.0 --port 8000

      - name: Update Frontend (PowerShell Fix)
        shell: powershell
        run: |
          Set-Location frontend
          
          Write-Host "1. Stopping Frontend (Safe Mode)..."
          # We use cmd /c here to safely swallow the error if the process doesn't exist
          cmd /c "pm2 delete frontend 2>NUL || ver > NUL"
          
          Write-Host "2. Installing Dependencies..."
          npm install
          if ($LASTEXITCODE -ne 0) { Write-Error "NPM Install Failed"; exit 1 }

          Write-Host "3. Cleaning Old Build..."
          if (Test-Path .next) { Remove-Item .next -Recurse -Force }

          Write-Host "4. Building New Version (This takes time)..."
          npm run build
          if ($LASTEXITCODE -ne 0) { Write-Error "Build Failed"; exit 1 }

          Write-Host "5. Starting Frontend..."
          $CurrentPath = (Get-Location).Path
          # We restart via cmd to ensure the path is set correctly
          cmd /c "pm2 start node_modules/next/dist/bin/next --name frontend --cwd ""$CurrentPath"" -- start"
          
          pm2 save