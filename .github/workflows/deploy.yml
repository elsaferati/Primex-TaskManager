name: Primex Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Env Files
        shell: cmd
        run: |
          echo NEXT_PUBLIC_API_URL=https://api-flow.primexeu.com > frontend/.env.local
          echo DATABASE_URL=postgresql+asyncpg://postgres:12345678@localhost:5433/primex_nexus > backend/.env
          echo JWT_SECRET=primex_nexus_secret_key_2026 >> backend/.env
          echo REDIS_URL=redis://localhost:6379/0 >> backend/.env
          echo CORS_ORIGINS=https://primeflow.primexeu.com,https://api-flow.primexeu.com >> backend/.env

      - name: Update Backend
        shell: cmd
        run: |
          cd backend
          python -m pip install -r requirements.txt
          python -m pip install psycopg2-binary pydantic[email]
          python -m alembic upgrade head

      - name: Update Frontend
        shell: cmd
        run: |
          cd frontend
          npm install
          npm run build

      - name: Restart Services
        shell: cmd
        run: |
          pm2 restart all
          pm2 save