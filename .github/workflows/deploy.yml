name: Primex Auto Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      # THIS STEP AUTOMATICALLY PULLS THE LATEST CODE
      # You do not need a separate "git pull" command.
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          clean: false 
          fetch-depth: 0

      # 1. Stop everything so we can update files without "File Locked" errors
      # (Replacing 'pm2 restart' with this is safer for Windows)
      - name: Kill Processes (Silent)
        shell: cmd
        run: |
          pm2 stop all || ver > nul
          taskkill /F /IM python.exe /T || ver > nul
          taskkill /F /IM node.exe /T || ver > nul

      # 2. Create Env Files (Connects the config to the live URL)
      - name: Create Env Files
        shell: cmd
        run: |
          echo NEXT_PUBLIC_API_URL=https://api-flow.primexeu.com > frontend/.env.local
          echo DATABASE_URL=postgresql+asyncpg://postgres:12345678@localhost:5433/primex_nexus > backend/.env
          echo JWT_SECRET=primex_nexus_secret_key_2026 >> backend/.env
          echo REDIS_URL=redis://localhost:6379/0 >> backend/.env
          echo CORS_ORIGINS=https://primeflow.primexeu.com,https://api-flow.primexeu.com >> backend/.env

      # 3. Update Backend Dependencies and Database
      - name: Update Backend
        shell: cmd
        run: |
          cd backend
          "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" -m pip install -r requirements.txt
          "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" -m pip install psycopg2-binary pydantic[email]
          "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" -m alembic upgrade head

      # 4. Install and Rebuild Frontend
      - name: Update Frontend
        shell: cmd
        run: |
          cd frontend
          npm install
          npm run build

      # 5. Start Services Fresh
      - name: Start Services with PM2
        shell: cmd
        run: |
          pm2 delete all || ver > nul
          cd backend
          pm2 start "C:\Users\Administrator\AppData\Local\Programs\Python\Python313\python.exe" --name backend -- -m uvicorn app.main:app --host 0.0.0.0 --port 8000
          cd ../frontend
          pm2 start "node" --name frontend -- node_modules/next/dist/bin/next start -- -p 3000 -H 0.0.0.0
          pm2 save